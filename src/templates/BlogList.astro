---
import Layout from '../layouts/Layout.astro';
import type { CollectionEntry } from 'astro:content';

interface Props {
  entry: CollectionEntry<'pages'>;
  items?: CollectionEntry<'blog'>[];
  baseSlug?: string;
}

const { entry, items = [], baseSlug = 'blog' } = Astro.props;
const { Content } = await entry.render();
const { title, description, manualList } = entry.data;

const groupByYear = (posts: CollectionEntry<'blog'>[]) => {
  const grouped = new Map<string | number, CollectionEntry<'blog'>[]>();
  posts.forEach((post) => {
    const date = post.data.date ? new Date(post.data.date) : null;
    const year = date && !Number.isNaN(date.getFullYear()) ? date.getFullYear() : 'Undated';
    if (!grouped.has(year)) grouped.set(year, []);
    grouped.get(year)?.push(post);
  });

  return Array.from(grouped.entries())
    .sort((a, b) => (a[0] === 'Undated' ? 1 : b[0] === 'Undated' ? -1 : Number(b[0]) - Number(a[0])))
    .map(([year, posts]) => ({
      year,
      posts: posts.sort((a, b) => {
        const da = a.data.date ? new Date(a.data.date).getTime() : 0;
        const db = b.data.date ? new Date(b.data.date).getTime() : 0;
        return db - da;
      }),
    }));
};

const groupedPosts = manualList ? [] : groupByYear(items as CollectionEntry<'blog'>[]);
---

<Layout title={title} description={description}>
  <section class="blog-head">
    {description && <p class="blog-desc">{description}</p>}
  </section>

  {Content && (
    <article class="blog-intro">
      <div class="post-content-body">
        <Content />
      </div>
    </article>
  )}
</Layout>

<style>
  .blog-head {
    max-width: 720px;
    margin: 0 auto 2rem;
    text-align: center;
    padding: 0 1.5rem;
  }

  .blog-desc {
    margin: 0;
    font-size: 10rem;
    line-height: 1.6;
    color: var(--color-text-subtle, #666);
  }

  .blog-intro {
    max-width: 760px;
    margin: 0 auto 3rem;
    padding: 0 1.5rem;
  }
</style>
